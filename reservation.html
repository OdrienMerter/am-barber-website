<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation - AM BARBER Roubaix</title>
    
    <!-- Lien vers la feuille de style CSS (assurez-vous que le chemin est correct) -->
    <link rel="stylesheet" href="./css/reservation.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- Inclusion de Flatpickr (bibliothèque de calendrier) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
</head>
<body>

    <!-- ==================== CONTENU DE LA PAGE DE RÉSERVATION ==================== -->
    <main class="booking-page">
        <div class="booking__container">
            <div class="booking__header">
                <!-- Assurez-vous que le lien pointe vers votre page d'accueil -->
                <a href="index.html" class="back-link">&larr; Retour au site</a>
                <h1 class="section__title">Réservez votre rendez-vous</h1>
            </div>
            
            <!-- Formulaire avec l'action actuelle pour l'envoi potentiel à Formspree (peut être retiré ou adapté) -->
            <form class="booking__form" id="bookingForm" action="https://formspree.io/f/xvgbeork" method="post">
                <div class="booking__grid">
                    <div class="booking__group">
                        <label for="firstName" class="booking__label">Prénom *</label>
                        <input type="text" id="firstName" name="firstName" class="booking__input" required>
                    </div>
                    
                    <div class="booking__group">
                        <label for="lastName" class="booking__label">Nom *</label>
                        <input type="text" id="lastName" name="lastName" class="booking__input" required>
                    </div>
                    
                    <div class="booking__group">
                        <label for="phone" class="booking__label">Téléphone *</label>
                        <input type="tel" id="phone" name="phone" class="booking__input" required>
                    </div>
                    
                    <div class="booking__group">
                        <label for="email" class="booking__label">Email</label>
                        <input type="email" id="email" name="email" class="booking__input">
                    </div>
                    
                    <div class="booking__group">
                        <label for="service" class="booking__label">Service souhaité *</label>
                        <select id="service" name="service" class="booking__select" required>
                            <option value="">Choisir un service</option>
                            <option value="coupe-homme">Coupe Homme - 30€</option>
                            <option value="taille-barbe">Taille de Barbe - 20€</option>
                            <option value="forfait-coupe-barbe">Forfait Coupe & Barbe - 45€</option>
                            <option value="coupe-enfant">Coupe Enfant (-12 ans) - 25€</option>
                        </select>
                    </div>

                    <!-- Champ pour le sélecteur de date et heure avec Flatpickr -->
                    <div class="booking__group">
                        <label class="booking__label">Date et Heure *</label>
                        <input type="text" id="datetimePicker" name="datetimePicker" class="booking__input" placeholder="Sélectionnez une date et une heure" required>
                        <!-- Champs cachés pour stocker la date et l'heure sélectionnées, utilisés pour l'envoi au backend -->
                        <input type="hidden" id="selectedDate" name="selectedDate">
                        <input type="hidden" id="selectedTime" name="selectedTime">
                    </div>
                    
                    <div class="booking__group booking__group--full">
                        <label for="message" class="booking__label">Message (optionnel)</label>
                        <textarea id="message" name="message" class="booking__textarea" placeholder="Précisez vos souhaits ou demandes particulières..."></textarea>
                    </div>
                </div>
                
                <!-- Bouton de soumission -->
                <button type="submit" class="button booking__submit">
                    <i class="fa-solid fa-calendar-check"></i> Confirmer la réservation
                </button>
            </form>
            
            <div class="booking__info">
                <h4><i class="fa-solid fa-info-circle"></i> Informations importantes</h4>
                <p><strong>Confirmation :</strong> Vous recevrez un SMS/Email de confirmation sous 24h.</p>
                <p><strong>Annulation :</strong> Merci de nous prévenir au moins 2h à l'avance.</p>
                <p><strong>Contact :</strong> <a href="tel:0955367634">09 55 36 76 34</a> pour toute question.</p>
            </div>
        </div>
    </main>

    <!-- ==================== MODAL DE CONFIRMATION ==================== -->
    <div class="modal" id="confirmationModal">
        <div class="modal__content">
            <button class="modal__close" id="modalClose">&times;</button>
            <h3 class="modal__title"><i class="fa-solid fa-check-circle"></i> Demande envoyée !</h3>
            <p class="modal__text">
                Merci, votre demande a bien été prise en compte.<br>
                Nous vous confirmerons le rendez-vous par SMS sous 24h.
            </p>
            <button class="button" onclick="closeModal()">Parfait !</button>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    
    <!-- Inclusion des librairies JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script> <!-- Locale française pour Flatpickr -->
    
<script>
    // --- Configuration du Frontend ---

    // URL de votre backend (local pour le développement)
    // Assurez-vous que ce port correspond au port sur lequel votre backend tourne réellement
    const BACKEND_API_URL = 'http://localhost:3000'; 

    // --- Fonctions pour le calendrier et le formulaire ---

    /**
     * Retourne la configuration pour Flatpickr.
     */
    function getFlatpickrConfig() {
        const today = new Date();
        // Min: Demain (pour éviter de réserver pour aujourd'hui et permettre la vérification)
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1); 
        
        // Max: 3 mois à partir de maintenant
        const maxDate = new Date(today);
        maxDate.setMonth(today.getMonth() + 3); 

        return {
            enableTime: true,
            dateFormat: "Y-m-d H:i",       // Format interne utilisé pour les requêtes API
            altInput: true,               // Champ lisible par l'utilisateur
            altFormat: "d/m/Y H:i",       // Format affiché à l'utilisateur
            minDate: tomorrow,
            maxDate: maxDate,
            locale: "fr",                 // Utilise la locale française
            hourIncrement: 1,             // Incrément d'heure
            minuteIncrement: 30,          // Incrément de minute (pour des créneaux de 30min)
            disable: [
                function(date) {
                    // Désactive les dimanches (0) et lundis (1)
                    return (date.getDay() === 0 || date.getDay() === 1); 
                }
            ],
            // Optionnel : vous pouvez ajouter des logiques pour griser des dates ou heures spécifiques
            // si vous connaissez des indisponibilités à l'avance, mais la vérification backend est primordiale.
            
            onChange: function(selectedDates, dateStr, instance) {
                // Met à jour les champs cachés lors de la sélection
                if (selectedDates.length > 0) {
                    const selectedDateTime = selectedDates[0];
                    document.getElementById('selectedDate').value = instance.formatDate(selectedDateTime, "Y-m-d");
                    document.getElementById('selectedTime').value = instance.formatDate(selectedDateTime, "H:i");
                } else {
                    document.getElementById('selectedDate').value = '';
                    document.getElementById('selectedTime').value = '';
                }
            }
        };
    }

    /**
     * Ouvre le modal de confirmation.
     */
    function openConfirmationModal() {
        document.getElementById('confirmationModal').classList.add('show');
    }

    /**
     * Ferme le modal de confirmation et redirige.
     */
    function closeModal() {
        document.getElementById('confirmationModal').classList.remove('show');
        // Redirection vers la page d'accueil après fermeture du modal
        window.location.href = 'index.html'; 
    }

    /**
     * Écouteur d'événement principal qui se lance une fois la page chargée.
     */
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation du calendrier Flatpickr
        const datetimePicker = flatpickr("#datetimePicker", getFlatpickrConfig());

        // Récupération des éléments du DOM
        const bookingForm = document.getElementById('bookingForm');
        const confirmationModal = document.getElementById('confirmationModal');

        // --- Gestion de la soumission du formulaire ---
        bookingForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Empêche la soumission par défaut du formulaire HTML

            // Récupérer les valeurs sélectionnées
            const selectedDateValue = document.getElementById('selectedDate').value;
            const selectedTimeValue = document.getElementById('selectedTime').value;
            const selectedService = document.getElementById('service').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const message = document.getElementById('message').value;

            // Validation basique des champs obligatoires
            if (!selectedDateValue || !selectedTimeValue || !selectedService) {
                alert("Veuillez sélectionner un service, une date et une heure valide.");
                return;
            }

            // Construction des objets Date pour les appels API
            // On utilise l'heure locale du navigateur pour construire la date
            const selectedDateTime = new Date(`${selectedDateValue}T${selectedTimeValue}:00`);
            
            // Vérification si la date est valide avant de continuer
            if (isNaN(selectedDateTime.getTime())) {
                 alert("La date ou l'heure sélectionnée n'est pas valide.");
                 return;
            }

            // Formats ISO pour les requêtes backend
            const startDateTimeISO = selectedDateTime.toISOString();
            // Fin du créneau : 30 minutes après le début
            const endDateTimeISO = new Date(selectedDateTime.getTime() + 30 * 60 * 1000).toISOString(); 

            // --- Étape 1: Vérifier la disponibilité auprès du backend ---
            try {
                console.log(`Frontend: Appel à ${BACKEND_API_URL}/check-availability avec:`, { startDateTimeISO });
                const availabilityResponse = await fetch(`${BACKEND_API_URL}/check-availability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ startDateTimeISO: startDateTimeISO }),
                });

                // Si la réponse du backend n'est pas OK (ex: erreur 500 non gérée correctement)
                if (!availabilityResponse.ok) {
                    const errorData = await availabilityResponse.json().catch(() => ({ error: "Réponse invalide du serveur" }));
                    console.error("Frontend: Erreur réseau lors de la vérification de disponibilité:", availabilityResponse.status, errorData);
                    alert(`Erreur lors de la vérification de disponibilité: ${errorData.error || availabilityResponse.statusText}. Veuillez réessayer plus tard.`);
                    return; // Arrête le processus
                }

                const availabilityData = await availabilityResponse.json();

                if (!availabilityData.available) {
                    alert("Désolé, ce créneau horaire est déjà réservé. Veuillez en choisir un autre.");
                    // Optionnel: effacer la sélection du datetimePicker
                    datetimePicker.clear();
                    document.getElementById('selectedDate').value = '';
                    document.getElementById('selectedTime').value = '';
                    return; // Arrête le processus
                }

                // --- Étape 2: Si disponible, créer la réservation via le backend ---
                console.log(`Frontend: Créneau disponible. Appel à ${BACKEND_API_URL}/create-booking`);
                const bookingResponse = await fetch(`${BACKEND_API_URL}/create-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: `Réservation ${firstName} ${lastName} - ${selectedService}`,
                        startDateTimeISO: startDateTimeISO,
                        endDateTimeISO: endDateTimeISO,
                        description: `Client: ${firstName} ${lastName}\nTél: ${phone}\nEmail: ${email}\nMessage: ${message}`,
                        email: email, // Optionnel: pour inviter le client via Google Calendar
                    }),
                });

                // Vérification si la réponse du backend est OK
                if (!bookingResponse.ok) {
                    const errorData = await bookingResponse.json().catch(() => ({ error: "Réponse invalide du serveur" }));
                    console.error("Frontend: Erreur réseau lors de la création de réservation:", bookingResponse.status, errorData);
                    alert(`Erreur lors de la création de la réservation: ${errorData.error || bookingResponse.statusText}. Veuillez réessayer.`);
                    return; // Arrête le processus
                }

                const bookingData = await bookingResponse.json();

                if (bookingData.success) {
                    console.log("Frontend: Réservation créée avec succès par le backend. Affichage du modal.");
                    openConfirmationModal(); // Ouvre le modal de succès

                    // Optionnel : si vous voulez aussi envoyer un email via Formspree en plus de la création Google Calendar
                    // Vous pouvez faire un fetch vers Formspree ici, mais attention à ne pas le faire deux fois
                    // si le backend s'en occupe déjà.
                    
                } else {
                    // Gérer les erreurs retournées par le backend (ex: si le backend dit que ce n'est pas dispo après vérif)
                    alert(`Erreur lors de la création de la réservation: ${bookingData.error || 'Erreur inconnue'}. Veuillez réessayer.`);
                    console.error("Frontend: Erreur retournée par le backend:", bookingData);
                }

            } catch (error) {
                // Erreur réseau lors des appels fetch
                alert("Une erreur réseau s'est produite. Veuillez vérifier votre connexion et que le serveur backend est bien lancé.");
                console.error("Frontend: Erreur réseau globale:", error);
            }
        });
    });
</script>
</body>
</html>