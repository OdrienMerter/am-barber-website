<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation - AM BARBER Roubaix</title>
    
    <!-- Lien vers la feuille de style CSS -->
    <link rel="stylesheet" href="./css/reservation.css"> 
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- Inclusion de Flatpickr (bibliothèque de calendrier) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
</head>
<body>

    <!-- ==================== CONTENU DE LA PAGE DE RÉSERVATION ==================== -->
    <main class="booking-page">
        <div class="booking__container">
            <div class="booking__header">
                <!-- Lien pour retourner à la page d'accueil -->
                <a href="index.html" class="back-link">&larr; Retour au site</a>
                <h1 class="section__title">Réservez votre rendez-vous</h1>
            </div>
            
            <!-- Formulaire de réservation -->
            <form class="booking__form" id="bookingForm">
                <div class="booking__grid">
                    <div class="booking__group">
                        <label for="firstName" class="booking__label">Prénom *</label>
                        <input type="text" id="firstName" name="firstName" class="booking__input" required>
                    </div>
                    
                    <div class="booking__group">
                        <label for="lastName" class="booking__label">Nom *</label>
                        <input type="text" id="lastName" name="lastName" class="booking__input" required>
                    </div>
                    
                    <div class="booking__group">
                        <label for="phone" class="booking__label">Téléphone *</label>
                        <input type="tel" id="phone" name="phone" class="booking__input" required pattern="[0-9]{10}" title="Entrez un numéro de téléphone valide (10 chiffres)">
                    </div>
                    
                    <div class="booking__group">
                        <label for="email" class="booking__label">Email</label>
                        <input type="email" id="email" name="email" class="booking__input">
                    </div>
                    
                    <div class="booking__group">
                        <label for="service" class="booking__label">Service souhaité *</label>
                        <select id="service" name="service" class="booking__select" required>
                            <option value="">Choisir un service</option>
                            <option value="Coupe Homme">Coupe Homme - 30€</option>
                            <option value="Taille de Barbe">Taille de Barbe - 20€</option>
                            <option value="Forfait Coupe & Barbe">Forfait Coupe & Barbe - 45€</option>
                            <option value="Coupe Enfant (-12 ans)">Coupe Enfant (-12 ans) - 25€</option>
                        </select>
                    </div>

                    <!-- Champ pour le sélecteur de date et heure avec Flatpickr -->
                    <div class="booking__group">
                        <label class="booking__label">Date et Heure *</label>
                        <input type="text" id="datetimePicker" name="datetimePicker" class="booking__input" placeholder="Sélectionnez une date et une heure" required>
                        <!-- Champs cachés pour stocker la date et l'heure sélectionnées en format ISO -->
                        <input type="hidden" id="selectedDateTimeISO" name="selectedDateTimeISO">
                    </div>
                    
                    <div class="booking__group booking__group--full">
                        <label for="message" class="booking__label">Message (optionnel)</label>
                        <textarea id="message" name="message" class="booking__textarea" placeholder="Précisez vos souhaits ou demandes particulières..."></textarea>
                    </div>
                </div>
                
                <!-- Bouton de soumission -->
                <button type="submit" class="button booking__submit" id="submitButton">
                    <i class="fa-solid fa-calendar-check"></i> Confirmer la réservation
                </button>
            </form>
            
            <div class="booking__info">
                <h4><i class="fa-solid fa-info-circle"></i> Informations importantes</h4>
                <p><strong>Confirmation :</strong> Vous recevrez un SMS/Email de confirmation sous 24h.</p>
                <p><strong>Annulation :</strong> Merci de nous prévenir au moins 2h à l'avance.</p>
                <p><strong>Contact :</strong> <a href="tel:0955367634">09 55 36 76 34</a> pour toute question.</p>
            </div>
        </div>
    </main>

    <!-- ==================== MODAL DE CONFIRMATION ==================== -->
    <div class="modal" id="confirmationModal">
        <div class="modal__content">
            <button class="modal__close" id="modalClose">&times;</button>
            <h3 class="modal__title"><i class="fa-solid fa-check-circle"></i> Demande envoyée !</h3>
            <p class="modal__text">
                Merci, votre demande a bien été prise en compte.<br>
                Nous vous confirmerons le rendez-vous par SMS sous 24h.
            </p>
            <button class="button" id="modalConfirmButton">Parfait !</button>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    
    <!-- Inclusion des librairies JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script> <!-- Locale française pour Flatpickr -->
    
    <script>
        // --- Configuration du Frontend ---

        // URL de votre backend (local pour le développement)
        // Assurez-vous que ce port correspond au port sur lequel votre backend tourne réellement
        // et que les routes appelées correspondent à celles définies dans server.js (/api/...)
        const BACKEND_API_URL = 'http://localhost:3000'; 

        // --- DOM Elements ---
        const bookingForm = document.getElementById('bookingForm');
        const datetimePickerInput = document.getElementById('datetimePicker');
        const selectedDateTimeISOInput = document.getElementById('selectedDateTimeISO');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalCloseButton = document.getElementById('modalClose');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const submitButton = document.getElementById('submitButton');

        // --- Fonctions Utilitaires ---

        /**
         * Affiche un message d'alerte au visiteur.
         * @param {string} message Le message à afficher.
         */
        function displayAlert(message) {
            alert(message);
        }

        /**
         * Affiche ou masque le bouton de soumission (utile pour le chargement).
         * @param {boolean} show True pour afficher, false pour masquer.
         */
        function toggleSubmitButton(show) {
            if (submitButton) {
                submitButton.disabled = !show;
                const icon = submitButton.querySelector('i');
                if (icon) {
                    if (show) {
                        icon.classList.remove('fa-spinner', 'fa-spin');
                        icon.classList.add('fa-calendar-check');
                    } else {
                        icon.classList.remove('fa-calendar-check');
                        icon.classList.add('fa-spinner', 'fa-spin');
                    }
                }
            }
        }

        /**
         * Ouvre le modal de confirmation.
         */
        function openConfirmationModal() {
            if (confirmationModal) {
                confirmationModal.classList.add('show');
            }
        }

        /**
         * Ferme le modal de confirmation et redirige vers la page d'accueil.
         */
        function closeModal() {
            if (confirmationModal) {
                confirmationModal.classList.remove('show');
            }
            window.location.href = 'index.html'; // Redirection vers la page d'accueil
        }

        /**
         * Configure Flatpickr pour le sélecteur de date et d'heure.
         * @returns {object} Configuration pour Flatpickr.
         */
        function getFlatpickrConfig() {
            const today = new Date();
            // Min: Demain (pour éviter de réserver pour aujourd'hui et permettre la vérification backend)
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1); 
            tomorrow.setHours(0, 0, 0, 0); // Commence à minuit demain

            // Max: 3 mois à partir de maintenant
            const maxDate = new Date(today);
            maxDate.setMonth(today.getMonth() + 3); 

            return {
                enableTime: true,
                dateFormat: "Y-m-d H:i",       // Format interne utilisé pour les requêtes API (ISO compatible)
                altInput: true,               // Champ lisible par l'utilisateur
                altFormat: "d/m/Y H:i",       // Format affiché à l'utilisateur
                minDate: tomorrow,            // Ne pas permettre de réserver avant demain
                maxDate: maxDate,             // Limite la réservation à 3 mois
                locale: "fr",                 // Utilise la locale française
                hourIncrement: 1,             // Incrément d'heure
                minuteIncrement: 30,          // Incrément de minute (pour des créneaux de 30min)
                disable: [
                    function(date) {
                        // Désactive les dimanches (0) et lundis (1)
                        const day = date.getDay();
                        return day === 0 || day === 1; 
                    }
                ],
                
                onChange: function(selectedDates, dateStr, instance) {
                    // Met à jour le champ caché avec la date/heure sélectionnée en format ISO
                    if (selectedDates.length > 0) {
                        const selectedDateTime = selectedDates[0];
                        // Utilisation de toISOString() pour obtenir le format attendu par le backend
                        selectedDateTimeISOInput.value = selectedDateTime.toISOString(); 
                    } else {
                        selectedDateTimeISOInput.value = '';
                    }
                }
            };
        }

        /**
         * Vérifie la disponibilité du créneau horaire via l'API backend.
         * @param {string} startDateTimeISO Date et heure de début au format ISO.
         * @returns {Promise<boolean>} True si disponible, false sinon.
         */
        async function checkAvailability(startDateTimeISO) {
            try {
                console.log(`Frontend: Appel à ${BACKEND_API_URL}/api/check-availability avec:`, { startDateTimeISO });
                const response = await fetch(`${BACKEND_API_URL}/api/check-availability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ startDateTimeISO: startDateTimeISO }),
                });

                if (!response.ok) {
                    // Tente de récupérer les détails de l'erreur, sinon utilise un message par défaut
                    let errorDetails = `Erreur réseau lors de la vérification de disponibilité: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error || errorDetails;
                    } catch (e) { /* Ignorer si la réponse n'est pas JSON */ }
                    
                    console.error("Frontend: Erreur lors de la vérification de disponibilité:", response.status, errorDetails);
                    displayAlert(`Impossible de vérifier la disponibilité: ${errorDetails}. Veuillez réessayer.`);
                    return false; // Indique que le créneau n'est pas considéré comme disponible (à cause de l'erreur)
                }

                const data = await response.json();
                return data.available; // Retourne true si disponible, false sinon

            } catch (error) {
                console.error("Frontend: Erreur réseau globale lors de la vérification de disponibilité:", error);
                displayAlert("Une erreur réseau s'est produite lors de la vérification de disponibilité. Veuillez vérifier votre connexion et que le serveur backend est bien lancé.");
                return false; // Indique que le créneau n'est pas disponible en cas d'erreur réseau
            }
        }

        /**
         * Crée une réservation via l'API backend.
         * @param {object} bookingData Les données de la réservation.
         * @returns {Promise<boolean>} True si la réservation a été créée avec succès, false sinon.
         */
        async function createBooking(bookingData) {
            try {
                console.log(`Frontend: Appel à ${BACKEND_API_URL}/api/create-booking`);
                const response = await fetch(`${BACKEND_API_URL}/api/create-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData),
                });

                if (!response.ok) {
                    let errorDetails = `Erreur lors de la création de la réservation: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error || errorDetails;
                    } catch (e) { /* Ignorer si la réponse n'est pas JSON */ }
                    
                    console.error("Frontend: Erreur lors de la création de réservation:", response.status, errorDetails);
                    displayAlert(`Erreur: ${errorDetails}. Veuillez réessayer.`);
                    return false; // Indique que la réservation a échoué
                }

                const data = await response.json();

                if (data.success) {
                    console.log("Frontend: Réservation créée avec succès par le backend.");
                    return true; // Indique que la réservation a réussi
                } else {
                    // Gérer les erreurs spécifiques retournées par le backend (ex: créneau non dispo après vérification)
                    displayAlert(`Erreur: ${data.error || 'Erreur inconnue côté serveur'}. Veuillez réessayer.`);
                    console.error("Frontend: Erreur retournée par le backend:", data);
                    return false;
                }

            } catch (error) {
                console.error("Frontend: Erreur réseau globale lors de la création de réservation:", error);
                displayAlert("Une erreur réseau s'est produite lors de la création de la réservation. Veuillez vérifier votre connexion et que le serveur backend est bien lancé.");
                return false; // Indique que la réservation a échoué
            }
        }

        // --- Gestionnaire d'Événement Principal ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // Initialisation du calendrier Flatpickr
            const datetimePicker = flatpickr(datetimePickerInput, getFlatpickrConfig());

            // --- Gestion de la soumission du formulaire ---
            bookingForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Empêche la soumission HTML par défaut

                // Afficher l'indicateur de chargement sur le bouton
                toggleSubmitButton(false);

                // Récupérer les valeurs du formulaire
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                const service = document.getElementById('service').value;
                const message = document.getElementById('message').value.trim();
                const selectedDateTimeISO = selectedDateTimeISOInput.value; // Valeur du champ caché

                // Validation basique des champs obligatoires
                if (!firstName || !lastName || !phone || !service || !selectedDateTimeISO) {
                    displayAlert("Veuillez remplir tous les champs obligatoires.");
                    toggleSubmitButton(true); // Réactiver le bouton
                    return;
                }

                // Calculer la date de fin (30 minutes après le début)
                const startTime = new Date(selectedDateTimeISO);
                const endTime = new Date(startTime.getTime() + 30 * 60 * 1000);
                const endDateTimeISO = endTime.toISOString();

                // --- Étape 1: Vérifier la disponibilité via le backend ---
                const isAvailable = await checkAvailability(selectedDateTimeISO);

                if (!isAvailable) {
                    displayAlert("Désolé, ce créneau horaire est déjà réservé ou indisponible. Veuillez en choisir un autre.");
                    // Optionnel: effacer la sélection du datetimePicker si indisponible
                    datetimePicker.clear();
                    selectedDateTimeISOInput.value = '';
                    toggleSubmitButton(true); // Réactiver le bouton
                    return; 
                }

                // --- Étape 2: Si disponible, créer la réservation via le backend ---
                const bookingData = {
                    summary: `Réservation ${service} - ${firstName} ${lastName}`,
                    startDateTimeISO: selectedDateTimeISO,
                    endDateTimeISO: endDateTimeISO,
                    description: `Client: ${firstName} ${lastName}\nTéléphone: ${phone}\nEmail: ${email}\nMessage: ${message}`,
                    email: email, // Transmettre l'email du client
                };

                const bookingSuccess = await createBooking(bookingData);

                if (bookingSuccess) {
                    openConfirmationModal(); // Ouvre le modal de succès
                } else {
                    // Un message d'erreur a déjà été affiché par createBooking
                    console.log("Frontend: Échec de la création de la réservation, le message d'erreur a été affiché.");
                }

                // Réactiver le bouton après le processus (succès ou échec)
                toggleSubmitButton(true); 
            });

            // --- Gestionnaires d'événements pour le Modal ---
            if (modalCloseButton) {
                modalCloseButton.addEventListener('click', closeModal);
            }
            if (modalConfirmButton) {
                modalConfirmButton.addEventListener('click', closeModal);
            }
            
            // Fermer le modal si l'utilisateur clique en dehors du contenu
            if (confirmationModal) {
                confirmationModal.addEventListener('click', (event) => {
                    if (event.target === confirmationModal) {
                        closeModal();
                    }
                });
            }
        });
    </script>
</body>
</html>